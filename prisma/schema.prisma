// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  name      String
  email     String     @unique
  password  String
  role      String   @default("STAFF")
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  submissions       Submission[]
  approvalsGiven    ApprovalStep[]
  activityLogs      ActivityLog[]
  submissionEdits   SubmissionVersion[]

  @@index([email])
  @@index([role])
}

model Submission {
  id               String     @id @default(cuid())
  submissionNumber String     @unique
  title            String
  description      String?
  department       String
  finalStatus      String @default("DRAFT")
  barcodeData      String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  requesterId      String
  requester        User       @relation(fields: [requesterId], references: [id])

  attachments      Attachment[]
  approvalSteps    ApprovalStep[]
  activityLogs     ActivityLog[]
  versions         SubmissionVersion[]

  @@index([requesterId])
  @@index([finalStatus])
  @@index([createdAt])
}

model ApprovalStep {
  id               String     @id @default(cuid())
  submissionId     String
  submission       Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  approverRole     String
  stepOrder        Int
  status           String @default("PENDING")
  
  approverId       String?
  approver         User?      @relation(fields: [approverId], references: [id])
  
  approvedAt       DateTime?
  note             String?
  signaturePath    String?
  
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@unique([submissionId, stepOrder])
  @@index([submissionId])
  @@index([approverRole])
  @@index([status])
}

model Attachment {
  id           String     @id @default(cuid())
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  fileName     String
  fileType     String
  fileSize     Int
  fileUrl      String
  
  uploadedAt   DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([submissionId])
}

model ActivityLog {
  id            String     @id @default(cuid())
  submissionId  String
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  
  action        String
  description   String?
  timestamp     DateTime   @default(now())

  @@index([submissionId])
  @@index([userId])
  @@index([timestamp])
}

model SubmissionVersion {
  id            String     @id @default(cuid())
  submissionId  String
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  versionNumber Int
  title         String
  description   String?
  
  updatedBy     String
  updatedByUser User       @relation(fields: [updatedBy], references: [id])
  
  updatedAt     DateTime   @default(now())

  @@unique([submissionId, versionNumber])
  @@index([submissionId])
}
